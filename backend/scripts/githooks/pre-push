#!/bin/bash
#
# pre-push - Quality checks before pushing to remote
#
# Description: This script performs quality checks before pushing to a remote repository.
# Author: Mauricio Pasten (@mrp4sten)
# Version: 1.2.0
# Created: 2025-10-01
# Updated: 2025-10-02 - Fixed backend paths
#

set -euo pipefail

echo "ðŸš€ Running pre-push quality checks..."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

CURRENT_BRANCH=$(git symbolic-ref --short HEAD)

# Branch protection
if [[ "$CURRENT_BRANCH" == "main" ]]; then
    log_error "You're pushing directly to main! Consider using a feature branch."
    echo "   Use: git checkout -b feature/your-feature"
    exit 1
fi

# Backend-specific checks (only if backend exists)
if [[ -d "backend" && -f "backend/pom.xml" ]]; then
    log_info "Running SonarQube analysis..."
		if [[ -n "${SONAR_TOKEN:-}" ]]; then
				if ! (cd backend && ./scripts/analyze-with-sonar.sh > /dev/null 2>&1); then
						log_error "SonarQube quality gate failed! Fix issues before pushing."
						exit 1
				fi
		else
				log_info "SONAR_TOKEN not set, skipping SonarQube analysis"
		fi
else
    log_info "No backend project found - skipping backend checks"
fi

log_info "âœ… Pre-push checks passed!"