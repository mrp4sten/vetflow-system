#!/bin/bash
#
# pre-commit - Quality checks before committing
#
# Description: This script performs quick quality checks before allowing a commit.
# Author: Mauricio Pasten (@mrp4sten)
# Version: 1.2.0
# Created: 2025-10-01
# Updated: 2025-10-02 - Fixed paths for multi-module structure
#

set -euo pipefail

echo "🔍 Running pre-commit quality checks..."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Backend checks (only if backend directory exists)
if [[ -d "backend" && -f "backend/pom.xml" ]]; then
    log_info "Backend project detected - running Java checks..."
    
    log_info "Checking project compilation..."
    if ! (cd backend && mvn compile -q > /dev/null 2>&1); then
        log_error "Backend doesn't compile! Fix compilation errors before committing."
        exit 1
    fi

    log_info "Running tests..."
    if ! (cd backend && mvn test -q > /dev/null 2>&1); then
        log_warning "Some backend tests are failing! Consider fixing them."
    fi
else
    log_info "No backend project found - skipping Java checks"
fi

# Database checks
if [[ -d "database" && -f "database/schema.sql" ]]; then
    log_info "Database directory detected - validating SQL structure..."
    # Basic check that schema.sql exists and is not empty
    if [[ ! -s "database/schema.sql" ]]; then
        log_error "database/schema.sql is empty!"
        exit 1
    fi
    log_info "✅ SQL structure looks good"
fi

# General security checks for all directories
log_info "Checking for potential secrets..."
if git diff --cached --name-only | xargs grep -n -i "password\|token\|secret\|key" 2>/dev/null || true; then
    log_warning "Potential secrets detected in staged files. Please review."
fi

log_info "✅ Pre-commit checks passed!"